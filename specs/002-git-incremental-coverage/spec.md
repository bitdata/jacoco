# Feature Specification: Git增量代码覆盖率分析

**Feature Branch**: `002-git-incremental-coverage`  
**Created**: 2025-12-25  
**Status**: Draft  
**Input**: User description: "**任务**：JaCoCo二次开发。**背景**：本项目Fork自开源项目JaCoCo。JaCoCo是Java平台受欢迎的代码覆盖率分析工具。现需要在该项目中添加基于Git的增量代码分析功能，即仅验证测试用例是否覆盖自某次提交以来的代码。**要求**：1. 工具命令行参数中增加代码branch-name和commit。commit的格式与git checkout等命令相同。如果省略commit，则从该分支第一次提交开始。2. 各种代码覆盖率指标的计算仅针对该分支该次commit（含该次）后提交的代码。3. 技术栈、命名约定尽量与原代码兼容。4. 其他输入输出格式保持不变。"

**注意**: 本文档及所有相关文档必须使用中文编写（遵循项目宪法原则）。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基于分支和提交的增量覆盖率分析 (Priority: P1)

作为开发者，我希望能够指定Git分支和提交来执行增量代码覆盖率分析，这样我就可以只关注最近修改的代码的测试覆盖率，而不需要分析整个代码库。

**Why this priority**: 这是核心功能，没有它就无法实现增量分析。这是MVP的最小可行功能。

**Independent Test**: 可以通过运行JaCoCo CLI命令，指定分支名称和提交哈希，验证生成的覆盖率报告仅包含指定提交之后的代码变更。可以通过对比完整覆盖率报告和增量覆盖率报告来验证功能正确性。

**Acceptance Scenarios**:

1. **Given** 一个包含多个提交的Git仓库，**When** 用户运行JaCoCo报告命令并指定分支名称和提交哈希，**Then** 系统仅分析该提交（含该提交）之后修改的代码文件，并生成覆盖率报告
2. **Given** 一个包含多个提交的Git仓库，**When** 用户运行JaCoCo报告命令并仅指定分支名称（不指定提交），**Then** 系统从该分支的第一次提交开始分析所有代码，并生成覆盖率报告
3. **Given** 用户指定了分支和提交，**When** 系统执行覆盖率分析，**Then** 覆盖率指标（行覆盖率、分支覆盖率、方法覆盖率等）仅针对增量代码计算
4. **Given** 用户运行增量覆盖率分析，**When** 生成的报告格式与原有报告格式相同，**Then** 用户可以像使用原有报告一样查看和使用增量覆盖率报告

---

### User Story 2 - 支持多种Git提交标识格式 (Priority: P2)

作为开发者，我希望能够使用各种Git提交标识格式（完整哈希、短哈希、标签、相对引用等），这样我就可以灵活地指定要分析的代码范围。

**Why this priority**: 提高工具的易用性和灵活性，支持Git的标准提交引用格式，与git checkout等命令保持一致。

**Independent Test**: 可以通过使用不同的提交标识格式（如完整哈希、短哈希、HEAD~1、标签名等）运行命令，验证系统能够正确解析并定位到对应的提交。

**Acceptance Scenarios**:

1. **Given** 用户指定完整的提交哈希（40位），**When** 系统执行分析，**Then** 系统能够正确识别并定位到该提交
2. **Given** 用户指定短提交哈希（7位或更多），**When** 系统执行分析，**Then** 系统能够正确识别并定位到唯一对应的提交
3. **Given** 用户指定Git标签名称，**When** 系统执行分析，**Then** 系统能够正确解析标签并定位到对应的提交
4. **Given** 用户指定相对引用（如HEAD~1、HEAD^），**When** 系统执行分析，**Then** 系统能够正确解析相对引用并定位到对应的提交

---

### User Story 3 - 增量代码文件识别和过滤 (Priority: P2)

作为开发者，我希望系统能够准确识别自指定提交以来修改的Java源文件和类文件，这样覆盖率分析才能正确聚焦于增量代码。

**Why this priority**: 这是增量分析准确性的基础，必须正确识别哪些文件属于增量代码范围。

**Independent Test**: 可以通过在Git仓库中创建测试场景（修改某些文件，添加新文件，删除文件），然后运行增量分析，验证系统能够正确识别出修改和新增的文件，并排除未修改的文件。

**Acceptance Scenarios**:

1. **Given** 指定提交之后有文件被修改，**When** 系统执行增量分析，**Then** 这些修改的文件被包含在分析范围内
2. **Given** 指定提交之后有新文件被添加，**When** 系统执行增量分析，**Then** 这些新文件被包含在分析范围内
3. **Given** 指定提交之后有文件被删除，**When** 系统执行增量分析，**Then** 这些删除的文件不影响覆盖率计算（因为它们不再存在于当前代码库中）
4. **Given** 指定提交之后未修改的文件，**When** 系统执行增量分析，**Then** 这些文件被排除在覆盖率计算之外

---

### Edge Cases

- 当指定的分支不存在时，系统如何处理？
- 当指定的提交哈希不存在或无法解析时，系统如何处理？
- 当指定的提交在当前分支的历史记录中不存在时，系统如何处理？
- 当仓库不是Git仓库或.git目录不存在时，系统如何处理？
- 当指定的提交之后没有任何代码变更时，覆盖率报告应该显示什么？
- 当Java源文件被重命名时，系统如何识别这是修改还是新增/删除？
- 当提交范围跨越多个分支合并时，系统如何确定增量代码范围？
- 当工作目录有未提交的更改时，系统如何处理？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在CLI命令中支持`--branch`参数，用于指定Git分支名称
- **FR-002**: 系统必须在CLI命令中支持`--commit`参数，用于指定Git提交标识（格式与git checkout命令兼容）
- **FR-003**: 当用户指定了`--branch`但未指定`--commit`时，系统必须从该分支的第一次提交开始分析
- **FR-004**: 系统必须能够解析Git提交标识的各种格式（完整哈希、短哈希、标签、相对引用如HEAD~1等）
- **FR-005**: 系统必须仅对指定提交（含该提交）之后修改或新增的Java源文件进行覆盖率分析
- **FR-006**: 系统必须计算增量代码的各种覆盖率指标（行覆盖率、分支覆盖率、方法覆盖率、类覆盖率、指令覆盖率）
- **FR-007**: 系统生成的覆盖率报告格式必须与原有JaCoCo报告格式保持一致（XML、HTML、CSV等格式）
- **FR-008**: 系统必须能够识别Git仓库中自指定提交以来的文件变更（新增、修改、删除、重命名）
- **FR-009**: 当指定的分支或提交不存在时，系统必须返回明确的错误信息
- **FR-010**: 系统必须保持与原有JaCoCo CLI命令的兼容性，不指定`--branch`和`--commit`时行为与原有功能一致
- **FR-011**: 系统必须能够处理跨分支的提交范围（如合并提交）
- **FR-012**: 系统必须能够正确匹配Java源文件（.java）和对应的类文件（.class）

### Key Entities *(include if feature involves data)*

- **Git提交范围**: 包含起始提交哈希、分支名称、提交时间等信息，用于确定增量代码的范围
- **增量代码文件集合**: 包含自指定提交以来修改或新增的Java源文件路径列表
- **覆盖率数据**: 包含行覆盖率、分支覆盖率、方法覆盖率等指标，仅针对增量代码计算
- **Git仓库信息**: 包含仓库路径、当前分支、提交历史等信息，用于执行Git操作

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够通过指定`--branch`和`--commit`参数成功执行增量覆盖率分析，成功率≥95%
- **SC-002**: 增量覆盖率报告仅包含指定提交之后的代码变更，准确率100%（通过对比Git diff和报告内容验证）
- **SC-003**: 系统能够正确解析Git提交标识的各种格式（完整哈希、短哈希、标签、相对引用），解析成功率≥99%
- **SC-004**: 增量覆盖率报告格式与原有报告格式完全兼容，现有工具和脚本能够无缝使用增量报告
- **SC-005**: 当用户未指定增量分析参数时，系统行为与原有JaCoCo功能100%一致（向后兼容）
- **SC-006**: 系统能够处理包含1000+个文件的代码库，增量分析性能与完整分析相当（分析时间差异<10%）
- **SC-007**: 用户能够在5分钟内理解如何使用新的增量分析功能（通过文档和示例）

## Assumptions

- Git仓库结构完整，.git目录存在且可访问
- 用户指定的分支和提交存在于Git仓库中
- Java源文件和类文件能够通过标准路径映射关系进行匹配
- Git命令（git diff, git log等）在系统PATH中可用
- 代码库使用标准的Git工作流，提交历史清晰
- 用户熟悉基本的Git概念和命令

